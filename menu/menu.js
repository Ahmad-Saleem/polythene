"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _polythenePolythenePolythene=require("polythene/polythene/polythene");var _polythenePolythenePolythene2=_interopRequireDefault(_polythenePolythenePolythene);var _mithril=require("mithril");var _mithril2=_interopRequireDefault(_mithril);var _polytheneShadowShadow=require("polythene/shadow/shadow");var _polytheneShadowShadow2=_interopRequireDefault(_polytheneShadowShadow);var _polytheneCommonTransition=require("polythene/common/transition");var _polytheneCommonTransition2=_interopRequireDefault(_polytheneCommonTransition);require("polythene-theme/menu/menu");var OFFSET_V=-8;var DEFAULT_OFFSET_H=16;var SHOW_CLASS="visible";var positionMenu=function positionMenu(ctrl,opts){if(!opts.target){return}var targetEl=document.querySelector("#"+opts.target);if(!targetEl){return}var offsetH=opts.offset!==undefined?opts.offset:DEFAULT_OFFSET_H;var menuEl=ctrl.el;if(!menuEl){return}var contentEl=ctrl.contentEl;var origin=opts.origin||"top-left";var reposition=opts.reposition===false?false:true;var positionOffset=0;if(reposition){var firstItem=contentEl.querySelectorAll(".list .list-tile")[0];var selectedItem=contentEl.querySelector(".list-tile.selected");if(selectedItem){var firstItemRect=firstItem.getBoundingClientRect();var selectedItemRect=selectedItem.getBoundingClientRect();positionOffset=selectedItemRect.top-firstItemRect.top}var alignEl=selectedItem||firstItem;var alignRect=alignEl.getBoundingClientRect();var _targetRect=targetEl.getBoundingClientRect();var heightDiff=alignRect.height-_targetRect.height;positionOffset+=heightDiff/2}var targetRect=targetEl.getBoundingClientRect();var parentRect=menuEl.parentNode.getBoundingClientRect();var alignLeft=function alignLeft(){return menuEl.style.left=targetRect.left-parentRect.left+offsetH+"px"};var alignRight=function alignRight(){return menuEl.style.right=targetRect.right-parentRect.right+offsetH+"px"};var alignTop=function alignTop(){return menuEl.style.top=targetRect.top-parentRect.top-positionOffset+OFFSET_V+"px"};var alignBottom=function alignBottom(){return menuEl.style.bottom=targetRect.bottom-parentRect.bottom-positionOffset+"px"};var alignFn={"top-left":function topLeft(){return alignTop()&&alignLeft()},"top-right":function topRight(){return alignTop()&&alignRight()},"bottom-left":function bottomLeft(){return alignBottom()&&alignLeft()},"bottom-right":function bottomRight(){return alignBottom()&&alignRight()}};alignFn[origin].call()};var show=function show(ctrl,opts){ctrl.isTransitioning=true;return _polytheneCommonTransition2["default"].show(Object.assign({},opts,{el:ctrl.el,showClass:SHOW_CLASS})).then(function(){ctrl.isTransitioning=false;ctrl.visible=true;if(opts.didShow){opts.didShow(opts.id)}})};var hide=function hide(ctrl,opts){ctrl.isTransitioning=true;return _polytheneCommonTransition2["default"].hide(Object.assign({},opts,{el:ctrl.el,showClass:SHOW_CLASS})).then(function(){ctrl.isTransitioning=false;ctrl.visible=false;if(opts.didHide){opts.didHide(opts.id)}_mithril2["default"].redraw()})};var unifySize=function unifySize(size){return size<1.5?1.5:size};var widthClass=function widthClass(size){if(size===1.5){return"width-1-half"}else{return"width-"+size}};var createView=function createView(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];var listenEl=document.body;var activateDismissTap=function activateDismissTap(){listenEl.addEventListener("click",handleDismissTap)};var deActivateDismissTap=function deActivateDismissTap(){listenEl.removeEventListener("click",handleDismissTap)};var handleDismissTap=function handleDismissTap(e){if(e.target===ctrl.el){return}deActivateDismissTap();if(e.defaultPrevented){hide(ctrl,opts)}else{hide(ctrl,Object.assign({},opts,{hideDelay:0}))}};var tag=opts.tag||"div";var props={"class":["menu",opts.permanent?"permanent":null,opts.target?"target":"layout center-center",opts.size?widthClass(unifySize(opts.size)):null,opts["class"]].join(" "),id:opts.id||"",config:function config(el,inited,context,vdom){if(inited){return}if(opts.config){opts.config(el,inited,context,vdom)}ctrl.el=el;var update=function update(){positionMenu(ctrl,opts);_mithril2["default"].redraw()};var handleEscape=function handleEscape(e){if(e.which===27){hide(ctrl,Object.assign({},opts,{hideDelay:0}))}};if(!opts.permanent){_polythenePolythenePolythene2["default"].addListener("resize",update);_polythenePolythenePolythene2["default"].addListener("keydown",handleEscape);setTimeout(function(){activateDismissTap();show(ctrl,opts)},0)}context.onunload=function(){_polythenePolythenePolythene2["default"].removeListener("resize",update);_polythenePolythenePolythene2["default"].removeListener("keydown",handleEscape);if(!opts.permanent){deActivateDismissTap()}};positionMenu(ctrl,opts)}};var content=(0,_mithril2["default"])(".menu-content",{config:function config(el,inited){if(!inited){ctrl.contentEl=el}},onclick:function onclick(e){e.preventDefault()}},[_mithril2["default"].component(_polytheneShadowShadow2["default"],{z:ctrl.z,animated:true}),opts.content?opts.content:null]);return(0,_mithril2["default"])(tag,props,_polythenePolythenePolythene2["default"].insertContent(content,opts))};var component={controller:function controller(){var opts=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var z=opts.z!==undefined?opts.z:1;return{z:z,el:null,contentEl:null,isTransitioning:false,visible:opts.permanent||false}},view:function view(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];if(opts.show&&!ctrl.visible){ctrl.visible=true}if(ctrl.visible){return createView(ctrl,opts)}else{return(0,_mithril2["default"])("span.menu-placeholder")}}};exports["default"]=component;module.exports=exports["default"];