{"version":3,"file":"polythene-core-menu.js","sources":["../src/classes.js","../src/menu.js","../src/vars.js"],"sourcesContent":["import { classes as coreListTileClasses } from \"polythene-core-list-tile\";\n\nexport default {\n  component:   \"pe-menu\",\n\n  // elements\n  content:     \"pe-menu__content\",\n  placeholder: \"pe-menu__placeholder\",\n  target:      \"pe-menu__target\",\n\n  // states\n  permanent:   \"pe-menu--permanent\",\n  visible:     \"pe-menu--visible\",\n  width_auto:  \"pe-menu--width-auto\",\n  width_n:     \"pe-menu--width-\",\n\n  // lookup\n  listTile:         coreListTileClasses.component,\n  selectedListTile: coreListTileClasses.selected,\n};\n","import { filterSupportedAttributes, subscribe, unsubscribe, show, hide, isServer } from \"polythene-core\";\nimport classes from \"./classes\";\n\nexport const getElement = vnode =>\n  vnode.attrs.element || \"div\";\n\nconst SHADOW_Z         = 1;\nconst OFFSET_V         = -8;\nconst DEFAULT_OFFSET_H = 0;\nconst MIN_SIZE         = 1.5;\n\nconst positionMenu = (state, attrs) => {\n  if (isServer) {\n    return;\n  }\n  const targetEl = document.querySelector(attrs.target);\n  if (!targetEl) {\n    return;\n  }\n  const offsetH = (attrs.offset !== undefined) ? attrs.offset : DEFAULT_OFFSET_H;\n  const menuEl = state.dom();\n  if (!menuEl) {\n    return;\n  }\n  const contentEl = state.dom().querySelector(\".\" + classes.content);\n  const origin = attrs.origin || \"top-left\";\n  let positionOffset = 0;\n  if (attrs.reposition) {\n    const firstItem = contentEl.querySelectorAll(\".\" + classes.listTile)[0];\n    const selectedItem = contentEl.querySelector(\".\" + classes.selectedListTile);\n    if (firstItem && selectedItem) {\n      // calculate v position: menu should shift upward relative to the first item\n      const firstItemRect = firstItem.getBoundingClientRect();\n      const selectedItemRect = selectedItem.getBoundingClientRect();\n      positionOffset = selectedItemRect.top - firstItemRect.top;\n    }\n    // align to middle of target\n    const alignEl = selectedItem || firstItem;\n    const alignRect = alignEl.getBoundingClientRect();\n    const targetRect = targetEl.getBoundingClientRect();\n    const heightDiff = alignRect.height - targetRect.height;\n    positionOffset += heightDiff / 2;\n  }\n  const targetRect = targetEl.getBoundingClientRect();\n  if (menuEl.parentNode) {\n    const parentRect = menuEl.parentNode.getBoundingClientRect();\n    const alignLeft =   () => menuEl.style.left = targetRect.left - parentRect.left + offsetH + \"px\";\n    const alignRight =  () => menuEl.style.right = targetRect.right - parentRect.right + offsetH + \"px\";\n    const alignTop =    () => menuEl.style.top = targetRect.top - parentRect.top - positionOffset + OFFSET_V + \"px\";\n    const alignBottom = () => menuEl.style.bottom = targetRect.bottom - parentRect.bottom - positionOffset + \"px\";\n    const alignFn = {\n      \"top-left\":       () => alignTop() && alignLeft(),\n      \"top-right\":      () => alignTop() && alignRight(),\n      \"bottom-left\":    () => alignBottom() && alignLeft(),\n      \"bottom-right\":   () => alignBottom() && alignRight()\n    };\n    alignFn[origin].call();\n  }\n};\n\nconst showMenu = (state, attrs) => {\n  if (attrs.onChange) {\n    attrs.onChange({ visible: false, transitioning: true });\n  }\n  positionMenu(state, attrs);\n  const transitions = attrs.transitions;\n  const el = state.dom();\n  return show(Object.assign({},\n    attrs,\n    transitions\n      ? transitions.show(el, attrs)\n      : {\n        el,\n        showClass: classes.visible\n      }\n  )).then(() => {\n    if (attrs.onChange) {\n      attrs.onChange({ visible: true, transitioning: false });\n    }\n    if (attrs.didShow) {\n      attrs.didShow(attrs.id);\n    }\n    state.visible(false);\n  });\n};\n\nconst hideMenu = (state, attrs) => {\n  if (attrs.onChange) {\n    attrs.onChange({ visible: true, transitioning: true });\n  }\n  const transitions = attrs.transitions;\n  const el = state.dom();\n  return hide(Object.assign({},\n    attrs,\n    transitions\n      ? transitions.hide(el, attrs)\n      : {\n        el,\n        showClass: classes.visible\n      }\n  )).then(() => {\n    if (attrs.onChange) {\n      attrs.onChange({ visible: false, transitioning: false });\n    }\n    if (attrs.didHide) {\n      attrs.didHide(attrs.id);\n    }\n    state.visible(false);\n  });\n};\n\nconst unifySize = size =>\n  size < MIN_SIZE ? MIN_SIZE : size;\n\nconst widthClass = size =>\n  classes.width_n + size.toString().replace(\".\", \"-\");\n\nconst handleSubscriptions = (vnode, which) => {\n  const state = vnode.state;\n  const attrs = vnode.attrs;\n\n  if (which === \"mount\") {\n    subscribe(\"resize\", state.update);\n    subscribe(\"keydown\", state.handleEscape);\n    setTimeout(() => {\n      state.activateDismissTap();\n      showMenu(state, attrs);\n    }, 0);\n  } else {\n    unsubscribe(\"resize\", state.update);\n    unsubscribe(\"keydown\", state.handleEscape);\n    state.deActivateDismissTap();\n  }\n};\n\nexport const onMount = vnode => {\n  if (!vnode.dom) {\n    return;\n  }\n  const state = vnode.state;\n  const attrs = vnode.attrs;\n  state.dom(vnode.dom);\n\n  if (!attrs.permanent) {\n    state.handleDismissTap = e => {\n      if (e.target === state.dom()) {\n        return;\n      }\n      if (e.defaultPrevented) {\n        // clicked on .pe-menu__content\n        hideMenu(state, attrs);\n      } else {\n        hideMenu(state, Object.assign({}, attrs, {\n          hideDelay: 0\n        }));\n      }\n    };\n\n    state.update = () => {\n      positionMenu(state, attrs);\n    };\n\n    state.activateDismissTap = () => {\n      document.body.addEventListener(\"click\", state.handleDismissTap);\n    };\n\n    state.deActivateDismissTap = () => {\n      document.body.removeEventListener(\"click\", state.handleDismissTap);\n    };\n\n    state.handleEscape = e => {\n      if (e.key === \"Escape\") {\n        hideMenu(state, Object.assign(\n          {},\n          attrs,\n          { hideDelay: 0 }\n        ));\n      }\n    };\n\n    handleSubscriptions(vnode, \"mount\");\n  }\n};\n\nexport const onUnMount = vnode => {\n  const attrs = vnode.attrs;\n  if (!attrs.permanent) {\n    handleSubscriptions(vnode, \"unmount\");\n  }\n};\n\nexport const getInitialState = (vnode, createStream) => {\n  const dom = createStream(null);\n  const visible = createStream(false);\n  return {\n    dom,\n    visible,\n    activateDismissTap: undefined, // set in onMount\n    deActivateDismissTap: undefined, // set in onMount\n    handleDismissTap: undefined, // set in onMount\n    handleEscape: undefined, // set in onMount\n    update: undefined, // set in onMount\n    redrawOnUpdate: createStream.merge([visible])\n  };\n};\n\nexport const createProps = (vnode, { keys: k }) => {\n  const attrs = vnode.attrs;\n  return Object.assign(\n    {}, \n    filterSupportedAttributes(attrs),\n    {\n      className: [\n        classes.component,\n        attrs.permanent ? classes.permanent : null,\n        attrs.target ? classes.target : null,\n        attrs.size ? widthClass(unifySize(attrs.size)) : null,\n        attrs.tone === \"dark\" ? \"pe-dark-tone\" : null,\n        attrs.tone === \"light\" ? \"pe-light-tone\" : null,\n        attrs.className || attrs[k.class],\n      ].join(\" \")\n    }\n  );\n};\n\nexport const createContent = (vnode, { renderer: h, keys: k, Shadow }) => {\n  const attrs = vnode.attrs;\n  const z = attrs.z !== undefined ? attrs.z : SHADOW_Z;\n  return h(\"div\",\n    {\n      className: classes.content,\n      [k.onclick]: e => e.preventDefault(),\n      style: attrs.style\n    },\n    [\n      z > 0 && h(Shadow, {\n        z,\n        animated: true\n      }),\n      attrs.content\n        ? attrs.content\n        : vnode.children\n    ]\n  );\n};\n","import { vars } from \"polythene-theme\";\n\nconst rgba = (colorStr, opacity = 1) =>\n  `rgba(${colorStr}, ${opacity})`;\n\nexport default {\n  sizes:                  [1, 1.5, 2, 3, 4, 5, 6, 7],\n  min_size:               1.5,\n  max_size_small_screen:  5,\n  size_factor:            vars.grid_unit_menu,\n  border_radius:          vars.unit_block_border_radius,\n\n  color_light_background: rgba(vars.color_light_background),\n  color_dark_background:  rgba(vars.color_dark_background)\n  // text colors are set by content, usually list tiles\n};\n"],"names":["coreListTileClasses","component","selected","getElement","vnode","attrs","element","positionMenu","state","isServer","targetEl","document","querySelector","target","offsetH","undefined","offset","menuEl","dom","contentEl","classes","content","origin","positionOffset","reposition","firstItem","querySelectorAll","listTile","selectedItem","selectedListTile","firstItemRect","getBoundingClientRect","selectedItemRect","top","alignRect","targetRect","heightDiff","height","parentNode","parentRect","alignLeft","style","left","alignRight","right","alignTop","alignBottom","bottom","call","showMenu","onChange","visible","transitioning","transitions","el","show","_extends","then","didShow","id","hideMenu","hide","didHide","unifySize","size","widthClass","width_n","toString","replace","handleSubscriptions","which","update","handleEscape","activateDismissTap","deActivateDismissTap","onMount","permanent","handleDismissTap","e","defaultPrevented","body","addEventListener","removeEventListener","key","hideDelay","onUnMount","getInitialState","createStream","merge","createProps","k","keys","filterSupportedAttributes","tone","className","class","join","createContent","h","renderer","Shadow","z","onclick","preventDefault","children","rgba","colorStr","vars","grid_unit_menu","unit_block_border_radius","color_light_background","color_dark_background"],"mappings":"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"}