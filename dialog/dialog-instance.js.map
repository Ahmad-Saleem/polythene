{"version":3,"sources":["dialog-instance.es6"],"names":["require","_events","_mithril","_dialog","_transition","_shadow","CSS_CLASSES","block","visible","body","fullscreen","content","header","footer","footerHigh","title","actions","hasBackdrop","hasTopOverflow","hasBottomOverflow","menuContent","SCROLL_WATCH_TIMER","updateScrollState","ctrl","scroller","scrollEl","topOverflow","scrollTop","bottomOverflow","scrollHeight","getBoundingClientRect","height","updateFooterState","footerEl","style","window","getComputedStyle","minHeight","parseInt","classList","add","remove","show","opts","id","instanceId","isTransitioning","_transition2","default","Object","assign","el","showClass","then","didShow","hide","_dialog2","didHide","setTimeout","_mithril2","redraw","createViewContent","bodyOpts","menu","tag","attrs","class","config","inited","onscroll","isScrolling","clearTimeout","scrollWatchId","children","createView","arguments","length","undefined","updateContentOnScroll","ignoreContent","update","props","backdrop","borders","join","context","vdom","cleanup","_events2","unsubscribe","handleEscape","e","which","hideDelay","subscribe","onunload","onclick","target","modal","formOptions","subtree","component","_shadow2","z","animated","headerHeight","footerHeight","before","after","controller","instanceData","view"],"mappings":"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","file":"dialog-instance.js","sourcesContent":["import 'polythene/common/object.assign';\nimport events from 'polythene/common/events';\nimport m from 'mithril';\nimport dialog from 'polythene/dialog/dialog';\nimport transition from 'polythene/common/transition';\nimport shadow from 'polythene/shadow/shadow';\nimport 'polythene/dialog/theme/theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-dialog',\n    visible: 'pe-dialog--visible',\n    body: 'pe-dialog__body',\n    fullscreen: 'pe-dialog--fullscreen',\n    content: 'pe-dialog__content',\n    header: 'pe-dialog__header',\n    footer: 'pe-dialog__footer',\n    footerHigh: 'pe-dialog__footer--high',\n    title: 'pe-dialog__title',\n    actions: 'pe-dialog__actions',\n    hasBackdrop: 'pe-dialog--backdrop',\n    hasTopOverflow: 'pe-dialog--overflow-top',\n    hasBottomOverflow: 'pe-dialog--overflow-bottom',\n    menuContent: 'pe-menu__content'\n};\n\nconst SCROLL_WATCH_TIMER = 150;\n\nconst updateScrollState = (ctrl) => {\n    const scroller = ctrl.scrollEl;\n    if (!scroller) {\n        return;\n    }\n    ctrl.topOverflow = (scroller.scrollTop > 0);\n    ctrl.bottomOverflow = (scroller.scrollHeight - (scroller.scrollTop + scroller.getBoundingClientRect().height) > 0);\n};\n\nconst updateFooterState = (ctrl) => {\n    const footerEl = ctrl.footerEl;\n    if (footerEl) {\n        const style = window.getComputedStyle(footerEl);\n        const height = footerEl.getBoundingClientRect().height;\n        const minHeight = parseInt(style.minHeight, 10);\n        if (height > minHeight) {\n            footerEl.classList.add(CSS_CLASSES.footerHigh);\n        } else {\n            footerEl.classList.remove(CSS_CLASSES.footerHigh);\n        }\n    }\n};\n\nconst show = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        if (ctrl.didShow) {\n            // notify multiple\n            ctrl.didShow(id);\n            // this will call opts.didShow\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        dialog.remove(id);\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        if (ctrl.didHide) {\n            // notify multiple\n            ctrl.didHide(id);\n            // this will call opts.didHide\n        }\n        setTimeout(m.redraw, 0); // removes remainder of drawn component\n    });\n};\n\nconst createViewContent = (ctrl, opts) => {\n    // if flex \"self-stretch\" is not supported, calculate the maximum height\n    let style = {};\n    const bodyOpts = opts.body || opts.menu;\n\n    return m('div', {\n        class: CSS_CLASSES.body,\n        style: style,\n        config: (el, inited) => {\n            if (inited) {\n                return;\n            }\n            ctrl.scrollEl = el;\n        },\n        onscroll: () => {\n            ctrl.isScrolling = true;\n            updateScrollState(ctrl);\n\n            clearTimeout(ctrl.scrollWatchId);\n            ctrl.scrollWatchId = setTimeout(() => {\n                ctrl.isScrolling = false;\n            }, SCROLL_WATCH_TIMER);\n        }\n    }, bodyOpts);\n};\n\nconst createView = (ctrl, opts = {}) => {\n    const bodyOpts = opts.body || opts.menu;\n    const updateContentOnScroll = opts.updateContentOnScroll || false;\n    const ignoreContent = !updateContentOnScroll && ctrl.isScrolling;\n    const tag = opts.tag || 'form';\n\n    const update = () => {\n        updateScrollState(ctrl);\n        updateFooterState(ctrl);\n        m.redraw();\n    };\n\n    const props = Object.assign({}, {\n        class: [\n            CSS_CLASSES.block,\n            (opts.fullscreen ? CSS_CLASSES.fullscreen : null),\n            (opts.backdrop ? CSS_CLASSES.hasBackdrop : null),\n            (ctrl.topOverflow || opts.borders ? CSS_CLASSES.hasTopOverflow : null),\n            (ctrl.bottomOverflow || opts.borders ? CSS_CLASSES.hasBottomOverflow : null),\n            ctrl.visible ? CSS_CLASSES.visible : null,\n            opts.class\n        ].join(' '),\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const cleanup = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n            };\n\n            const handleEscape = (e) => {\n                if (opts.fullscreen || opts.backdrop) return;\n                if (e.which === 27) {\n                    cleanup();\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            // resize: update scroll state ('overflow' borders)\n            events.subscribe('resize', update);\n            events.subscribe('keydown', handleEscape);\n\n            context.onunload = () => {\n                cleanup();\n            };\n\n            updateScrollState(ctrl);\n            updateFooterState(ctrl);\n\n            show(ctrl, opts).then(() => {\n                updateScrollState(ctrl);\n                updateFooterState(ctrl);\n                if (ctrl.topOverflow || ctrl.bottomOverflow) {\n                    setTimeout(m.redraw, 0);\n                }\n            });\n        },\n        // click backdrop: close dialog\n        onclick: (e) => {\n            if (e.target !== ctrl.el) {\n                return;\n            }\n            if (opts.modal) {\n                // not allowed\n                return;\n            }\n            if (!ctrl.isTransitioning) {\n                hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n            }\n        }\n    }, opts.formOptions ? opts.formOptions : null);\n\n    const body = bodyOpts ? (ignoreContent ? {\n        subtree: 'retain'\n    } : createViewContent(ctrl, opts)) : null;\n\n    const content = m('div', {\n        class: [CSS_CLASSES.content, (opts.menu ? CSS_CLASSES.menuContent : null)].join(' ')\n    }, [\n        opts.fullscreen ? null : m.component(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.fullscreen ? null : opts.title ? m('div', {\n            class: CSS_CLASSES.header,\n            config: (el) => {\n                ctrl.headerHeight = el.scrollHeight;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.title}, opts.title)\n        ]) : null,\n        body,\n        opts.fullscreen ? null : opts.footer ? m('div', {\n            class: CSS_CLASSES.footer,\n            config: (el, inited) => {\n                ctrl.footerHeight = el.scrollHeight;\n                if (inited) {\n                    return;\n                }\n                ctrl.footerEl = el;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.actions}, opts.footer)\n        ]) : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (instanceData = {}) => {\n        // instanceData contains {id, opts}\n        const opts = instanceData.opts || {};\n        let z = (opts.z !== undefined) ? opts.z : 3; // shadow depth\n        return Object.assign({}, instanceData, {\n            instanceId: instanceData.instanceId,\n            z: z,\n            scrollEl: null,\n            footerEl: null,\n            topOverflow: false,\n            bottomOverflow: false,\n            scrollWatchId: 0,\n            isScrolling: false,\n            headerHeight: 0,\n            footerHeight: 0,\n            el: null,\n            visible: instanceData.show ? true : false,\n            isTransitioning: false\n        });\n    },\n    view: (ctrl, instanceData) => {\n        // instanceData contains {id, opts}\n        const opts = (typeof instanceData.opts === 'function')\n            ? instanceData.opts()\n            : instanceData.opts;\n        if (instanceData.hide && !ctrl.isTransitioning) {\n            hide(ctrl, opts);\n        }\n        return createView(ctrl, opts);\n    }\n};\n\nexport default component;\n"]}