{"version":3,"sources":["dialog-instance.es6"],"names":[],"mappings":"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","file":"dialog-instance.js","sourcesContent":["import 'polythene/common/object.assign';\nimport events from 'polythene/common/events';\nimport m from 'mithril';\nimport dialog from 'polythene/dialog/dialog';\nimport transition from 'polythene/common/transition';\nimport shadow from 'polythene/shadow/shadow';\nimport 'polythene/dialog/theme/theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-dialog',\n    visible: 'pe-dialog--visible',\n    body: 'pe-dialog__body',\n    fullscreen: 'pe-dialog--fullscreen',\n    content: 'pe-dialog__content',\n    header: 'pe-dialog__header',\n    footer: 'pe-dialog__footer',\n    footerHigh: 'pe-dialog__footer--high',\n    title: 'pe-dialog__title',\n    actions: 'pe-dialog__actions',\n    hasBackdrop: 'pe-dialog--backdrop',\n    hasTopOverflow: 'pe-dialog--overflow-top',\n    hasBottomOverflow: 'pe-dialog--overflow-bottom',\n    menuContent: 'pe-menu__content'\n};\n\nconst SCROLL_WATCH_TIMER = 150;\n\nconst updateScrollState = (ctrl) => {\n    const scroller = ctrl.scrollEl;\n    if (!scroller) {\n        return;\n    }\n    ctrl.topOverflow = (scroller.scrollTop > 0);\n    ctrl.bottomOverflow = (scroller.scrollHeight - (scroller.scrollTop + scroller.getBoundingClientRect().height) > 0);\n};\n\nconst updateFooterState = (ctrl) => {\n    const footerEl = ctrl.footerEl;\n    if (footerEl) {\n        const style = window.getComputedStyle(footerEl);\n        const height = footerEl.getBoundingClientRect().height;\n        const minHeight = parseInt(style.minHeight, 10);\n        if (height > minHeight) {\n            footerEl.classList.add(CSS_CLASSES.footerHigh);\n        } else {\n            footerEl.classList.remove(CSS_CLASSES.footerHigh);\n        }\n    }\n};\n\nconst show = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        // dialog.setVisibleState(true, id);\n        if (opts.didShow) {\n            opts.didShow(id);\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        dialog.remove(id);\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        // dialog.setVisibleState(false, id);\n        if (opts.didHide) {\n            opts.didHide(id);\n        }\n        setTimeout(m.redraw, 0); // removes remainder of drawn component\n    });\n};\n\nconst createViewContent = (ctrl, opts) => {\n    // if flex \"self-stretch\" is not supported, calculate the maximum height\n    let style = {};\n    const bodyOpts = opts.body || opts.menu;\n\n    return m('div', {\n        class: CSS_CLASSES.body,\n        style: style,\n        config: (el, inited) => {\n            if (inited) {\n                return;\n            }\n            ctrl.scrollEl = el;\n        },\n        onscroll: () => {\n            ctrl.isScrolling = true;\n            updateScrollState(ctrl);\n\n            clearTimeout(ctrl.scrollWatchId);\n            ctrl.scrollWatchId = setTimeout(() => {\n                ctrl.isScrolling = false;\n            }, SCROLL_WATCH_TIMER);\n        }\n    }, bodyOpts);\n};\n\nconst createView = (ctrl, opts = {}) => {\n    const bodyOpts = opts.body || opts.menu;\n    const updateContentOnScroll = opts.updateContentOnScroll || false;\n    const ignoreContent = !updateContentOnScroll && ctrl.isScrolling;\n    const tag = opts.tag || 'form';\n\n    const update = () => {\n        updateScrollState(ctrl);\n        updateFooterState(ctrl);\n        m.redraw();\n    };\n\n    const props = Object.assign({}, {\n        class: [\n            CSS_CLASSES.block,\n            (opts.fullscreen ? CSS_CLASSES.fullscreen : null),\n            (opts.backdrop ? CSS_CLASSES.hasBackdrop : null),\n            (ctrl.topOverflow || opts.borders ? CSS_CLASSES.hasTopOverflow : null),\n            (ctrl.bottomOverflow || opts.borders ? CSS_CLASSES.hasBottomOverflow : null),\n            ctrl.visible ? CSS_CLASSES.visible : null,\n            opts.class\n        ].join(' '),\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const cleanup = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n            };\n\n            const handleEscape = (e) => {\n                if (opts.fullscreen || opts.backdrop) return;\n                if (e.which === 27) {\n                    cleanup();\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            // resize: update scroll state ('overflow' borders)\n            events.subscribe('resize', update);\n            events.subscribe('keydown', handleEscape);\n\n            context.onunload = () => {\n                cleanup();\n            };\n\n            updateScrollState(ctrl);\n            updateFooterState(ctrl);\n\n            show(ctrl, opts).then(() => {\n                updateScrollState(ctrl);\n                updateFooterState(ctrl);\n                if (ctrl.topOverflow || ctrl.bottomOverflow) {\n                    setTimeout(m.redraw, 0);\n                }\n            });\n        },\n        // click backdrop: close dialog\n        onclick: (e) => {\n            if (e.target !== ctrl.el) {\n                return;\n            }\n            if (opts.modal) {\n                // not allowed\n                return;\n            }\n            if (!ctrl.isTransitioning) {\n                hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n            }\n        }\n    }, opts.formOptions ? opts.formOptions : null);\n\n    const body = bodyOpts ? (ignoreContent ? {\n        subtree: 'retain'\n    } : createViewContent(ctrl, opts)) : null;\n\n    const content = m('div', {\n        class: [CSS_CLASSES.content, (opts.menu ? CSS_CLASSES.menuContent : null)].join(' ')\n    }, [\n        opts.fullscreen ? null : m.component(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.fullscreen ? null : opts.title ? m('div', {\n            class: CSS_CLASSES.header,\n            config: (el) => {\n                ctrl.headerHeight = el.scrollHeight;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.title}, opts.title)\n        ]) : null,\n        body,\n        opts.fullscreen ? null : opts.footer ? m('div', {\n            class: CSS_CLASSES.footer,\n            config: (el, inited) => {\n                ctrl.footerHeight = el.scrollHeight;\n                if (inited) {\n                    return;\n                }\n                ctrl.footerEl = el;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.actions}, opts.footer)\n        ]) : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (instanceData = {}) => {\n        // instanceData contains {id, opts}\n        const opts = instanceData.opts || {};\n        let z = (opts.z !== undefined) ? opts.z : 3; // shadow depth\n        return {\n            instanceId: instanceData.instanceId,\n            z: z,\n            scrollEl: null,\n            footerEl: null,\n            topOverflow: false,\n            bottomOverflow: false,\n            scrollWatchId: 0,\n            isScrolling: false,\n            headerHeight: 0,\n            footerHeight: 0,\n            el: null,\n            visible: false,\n            isTransitioning: false\n        };\n    },\n    view: (ctrl, instanceData) => {\n        // instanceData contains {id, opts}\n        const opts = (typeof instanceData.opts === 'function')\n            ? instanceData.opts()\n            : instanceData.opts;\n        if (instanceData.hide && !ctrl.isTransitioning) {\n            hide(ctrl, opts);\n        }\n        return createView(ctrl, opts);\n    }\n};\n\nexport default component;\n"]}