{"version":3,"file":"polythene-core-menu.js","sources":["../src/classes.js","../src/theme/vars.js","../src/theme/layout.js","../src/theme/color.js","../src/theme/index.js","../src/menu.js"],"sourcesContent":["import { classes as coreListTileClasses } from \"polythene-core-list-tile\";\n\nexport default {\n  component:   \"pe-menu\",\n\n  // elements\n  content:     \"pe-menu__content\",\n  placeholder: \"pe-menu__placeholder\",\n  target:      \"pe-menu__target\",\n\n  // states\n  permanent:   \"pe-menu--permanent\",\n  visible:     \"pe-menu--visible\",\n  width_auto:  \"pe-menu--width-auto\",\n  width_n:     \"pe-menu--width-\",\n\n  // lookup\n  listTile:         coreListTileClasses.component,\n  selectedListTile: coreListTileClasses.selected,\n};\n","import { vars } from \"polythene-theme\";\nconst rgba = vars.rgba;\n\nexport default {\n  sizes:                  [1, 1.5, 2, 3, 4, 5, 6, 7],\n  min_size:               1.5,\n  max_size_small_screen:  5,\n  size_factor:            vars.grid_unit_menu,\n  border_radius:          vars.unit_block_border_radius,\n\n  color_light_background: rgba(vars.color_light_background),\n  color_dark_background:  rgba(vars.color_dark_background)\n  // text colors are set by content, usually list tiles\n};\n","import { vars } from \"polythene-theme\";\nimport { mixin } from \"polythene-core-css\";\n\nconst unifySize = (componentVars, size) =>\n  size < componentVars.min_size ? componentVars.min_size : size;\n\nconst widthClass = size => {\n  const sizeStr = size.toString().replace(\".\", \"-\");\n  return \"pe-menu--width-\" + sizeStr;\n};\n\nconst widthStyle = (componentVars, size) => {\n  const s = unifySize(componentVars, size);\n  return {\n    [\"&.\" + widthClass(s)]: {\n      width: componentVars.size_factor * s + \"px\",\n      \"max-width\": \"100%\"\n    }\n  };\n};\n\nexport default (selector, componentVars) => [{\n  [selector]: [\n    componentVars.sizes.map((size) =>\n      widthStyle(componentVars, size)\n    ),\n    {\n      transitionTimingFunction: \"ease-out\",\n      transitionProperty: \"opacity\",\n      zIndex: vars.z_menu,\n      opacity: 0,\n      position: \"absolute\",\n      width: \"100%\",\n      minWidth: vars.grid_unit_menu * componentVars.min_size + \"px\",\n\n      \"&.pe-menu--width-auto\": {\n        width: \"auto\"\n      },\n\n      \"&.pe-menu--visible\": {\n        opacity: 1\n      },\n\n      \"&.pe-menu--permanent\": {\n        position: \"relative\",\n        opacity: 1,\n        zIndex: 0\n      },\n\n      \" .pe-menu__content\": {\n        width: \"100%\",\n        borderRadius: componentVars.border_radius + \"px\"\n      },\n\n      [\"@media (max-width: \" + vars.unit_screen_size_large + \"px)\"]: {\n        \"max-width\": componentVars.max_size_small_screen * vars.grid_unit_menu + \"px\"\n      }\n    }\n  ],\n  // In menu and in dialog:\n  \" .pe-menu__content\": {\n    \" .pe-list-tile__title\": [\n      mixin.ellipsis(\"none\")\n    ]\n  },\n}];\n","\nconst style = (scopes, selector, componentVars, tint) => [{\n  [scopes.map(s => s + selector).join(\",\")]: {\n    \" .pe-menu__content\": {\n      \"background-color\": componentVars[\"color_\" + tint + \"_background\"]\n    }\n  }\n}];\n\nexport default (selector, componentVars) => [\n  style([\".pe-dark-tone\", \".pe-dark-tone \"], selector, componentVars, \"dark\"), // has/inside dark tone\n  style([\"\", \".pe-light-tone\", \".pe-light-tone \"], selector, componentVars, \"light\"), // normal, has/inside light tone\n];\n","import { styler } from \"polythene-core-css\";\nimport classes from \"../classes\";\nimport vars from \"./vars\";\nimport layout from \"./layout\";\nimport color from \"./color\";\n\nconst fns = [layout, color];\nconst selector = `.${classes.component}`;\n\nexport const customTheme = (customSelector, customVars) => \n  styler.generateStyles([customSelector, selector], {...vars, ...customVars}, fns);\n\nstyler.generateStyles([selector], vars, fns);\n","import { filterSupportedAttributes, subscribe, unsubscribe, show, hide } from \"polythene-core\";\nimport { customTheme } from \"./theme\";\nimport classes from \"./classes\";\n\nexport const getElement = vnode =>\n  vnode.attrs.element || \"div\";\n\nexport const theme = customTheme;\n\nconst SHADOW_Z         = 1;\nconst OFFSET_V         = -8;\nconst DEFAULT_OFFSET_H = 16;\nconst MIN_SIZE         = 1.5;\n\nexport const getInitialState = (vnode, createStream) => {\n  const dom = createStream();\n  return { dom };\n};\n\nconst positionMenu = (state, attrs) => {\n  const targetEl = document.querySelector(attrs.target);\n  if (!targetEl) {\n    return;\n  }\n  const offsetH = (attrs.offset !== undefined) ? attrs.offset : DEFAULT_OFFSET_H;\n  const menuEl = state.dom();\n  if (!menuEl) {\n    return;\n  }\n  const contentEl = state.dom().querySelector(\".\" + classes.content);\n  const origin = attrs.origin || \"top-left\";\n  const reposition = attrs.reposition === false ? false : true;\n  let positionOffset = 0;\n  if (reposition) {\n    const firstItem = contentEl.querySelectorAll(\".\" + classes.listTile)[0];\n    const selectedItem = contentEl.querySelector(\".\" + classes.selectedListTile);\n    if (firstItem && selectedItem) {\n      // calculate v position: menu should shift upward relative to the first item\n      const firstItemRect = firstItem.getBoundingClientRect();\n      const selectedItemRect = selectedItem.getBoundingClientRect();\n      positionOffset = selectedItemRect.top - firstItemRect.top;\n    }\n    // align to middle of target\n    const alignEl = selectedItem || firstItem;\n    const alignRect = alignEl.getBoundingClientRect();\n    const targetRect = targetEl.getBoundingClientRect();\n    const heightDiff = alignRect.height - targetRect.height;\n    positionOffset += heightDiff / 2;\n  }\n  const targetRect = targetEl.getBoundingClientRect();\n  if (menuEl.parentNode) {\n    const parentRect = menuEl.parentNode.getBoundingClientRect();\n    const alignLeft =   () => menuEl.style.left = targetRect.left - parentRect.left + offsetH + \"px\";\n    const alignRight =  () => menuEl.style.right = targetRect.right - parentRect.right + offsetH + \"px\";\n    const alignTop =    () => menuEl.style.top = targetRect.top - parentRect.top - positionOffset + OFFSET_V + \"px\";\n    const alignBottom = () => menuEl.style.bottom = targetRect.bottom - parentRect.bottom - positionOffset + \"px\";\n    const alignFn = {\n      \"top-left\":       () => alignTop() && alignLeft(),\n      \"top-right\":      () => alignTop() && alignRight(),\n      \"bottom-left\":    () => alignBottom() && alignLeft(),\n      \"bottom-right\":   () => alignBottom() && alignRight()\n    };\n    alignFn[origin].call();\n  }\n};\n\nconst showMenu = (state, attrs) => {\n  attrs.setDisplayState({ transitioning: true });\n  return show(Object.assign({},\n    attrs, {\n      el: state.dom(),\n      showClass: classes.visible\n    }\n  )).then(() => {\n    attrs.setDisplayState({ visible: true });\n    if (attrs.didShow) {\n      attrs.didShow(attrs.id);\n    }\n  });\n};\n\nconst hideMenu = (state, attrs) => {\n  attrs.setDisplayState({ transitioning: true });\n  return hide(Object.assign({},\n    attrs, {\n      el: state.dom(),\n      showClass: classes.visible\n    }\n  )).then(() => {\n    attrs.setDisplayState({ visible: false });\n    if (attrs.didHide) {\n      attrs.didHide(attrs.id);\n    }\n  });\n};\n\nconst unifySize = size =>\n  size < MIN_SIZE ? MIN_SIZE : size;\n\nconst widthClass = size =>\n  classes.width_n + size.toString().replace(\".\", \"-\");\n\nexport const createProps = (vnode, { keys: k }) => {\n  const attrs = vnode.attrs;\n  return Object.assign(\n    {}, \n    filterSupportedAttributes(attrs),\n    {\n      className: [\n        classes.component,\n        attrs.permanent ? classes.permanent : null,\n        attrs.target ? classes.target : null,\n        attrs.size ? widthClass(unifySize(attrs.size)) : null,\n        attrs.tone === \"dark\" ? \"pe-dark-tone\" : null,\n        attrs.tone === \"light\" ? \"pe-light-tone\" : null,\n        attrs.className || attrs[k.class],\n      ].join(\" \")\n    }\n  );\n};\n\nconst handleSubscriptions = (vnode, which) => {\n  const state = vnode.state;\n  const attrs = vnode.attrs;\n\n  const update = () => {\n    positionMenu(state, attrs);\n  };\n\n  const handleDismissTap = e => {\n    if (e.target === state.dom()) {\n      return;\n    }\n    deActivateDismissTap();\n    if (e.defaultPrevented) {\n      // clicked on .pe-menu__content\n      hideMenu(state, attrs);\n    } else {\n      hideMenu(state, Object.assign({}, attrs, {\n        hideDelay: 0\n      }));\n    }\n  };\n\n  const listenEl = document.body;\n\n  const activateDismissTap = () => {\n    listenEl.addEventListener(\"click\", handleDismissTap);\n  };\n\n  const deActivateDismissTap = () => {\n    listenEl.removeEventListener(\"click\", handleDismissTap);\n  };\n\n  const handleEscape = e => {\n    if (e.which === 27) {\n      hideMenu(state, Object.assign(\n        {},\n        attrs,\n        { hideDelay: 0 }\n      ));\n    }\n  };\n\n  if (which === \"mount\") {\n    subscribe(\"resize\", update);\n    subscribe(\"keydown\", handleEscape);\n    setTimeout(() => {\n      activateDismissTap();\n      showMenu(state, attrs);\n    }, 0);\n  } else if (which === \"unmount\") {\n    unsubscribe(\"resize\", update);\n    unsubscribe(\"keydown\", handleEscape);\n    deActivateDismissTap();\n  }\n};\n\nexport const onMount = vnode => {\n  if (!vnode.dom) {\n    return;\n  }\n  const state = vnode.state;\n  const attrs = vnode.attrs;\n  state.dom(vnode.dom);\n  if (!attrs.permanent) {\n    handleSubscriptions(vnode, \"mount\");\n  }\n  positionMenu(state, attrs);\n};\n\nexport const onUnMount = vnode => {\n  const attrs = vnode.attrs;\n  if (!attrs.permanent) {\n    handleSubscriptions(vnode, \"unmount\");\n  }\n};\n\nexport const createContent = (vnode, { renderer: h, keys: k, Shadow }) => {\n  const attrs = vnode.attrs;\n  const z = attrs.z !== undefined ? attrs.z : SHADOW_Z;\n  return h(\"div\",\n    {\n      className: classes.content,\n      [k.onclick]: e => e.preventDefault(),\n      style: attrs.style\n    },\n    [\n      z > 0 && h(Shadow, {\n        z,\n        animated: true\n      }),\n      attrs.content\n        ? attrs.content\n        : vnode.children\n    ]\n  );\n};\n"],"names":["coreListTileClasses","component","selected","rgba","vars","grid_unit_menu","unit_block_border_radius","color_light_background","color_dark_background","unifySize","componentVars","size","min_size","widthClass","toString","replace","widthStyle","s","size_factor","selector","sizes","map","z_menu","border_radius","unit_screen_size_large","max_size_small_screen","mixin","ellipsis","style","scopes","tint","join","fns","layout","color","classes","customTheme","customSelector","customVars","styler","generateStyles","getElement","vnode","attrs","element","theme","getInitialState","createStream","dom","positionMenu","state","targetEl","document","querySelector","target","offsetH","undefined","offset","menuEl","contentEl","content","origin","positionOffset","reposition","firstItem","querySelectorAll","listTile","selectedItem","selectedListTile","firstItemRect","getBoundingClientRect","selectedItemRect","top","alignRect","targetRect","heightDiff","height","parentNode","parentRect","alignLeft","left","alignRight","right","alignTop","alignBottom","bottom","call","showMenu","setDisplayState","transitioning","show","_extends","visible","then","didShow","id","hideMenu","hide","didHide","width_n","createProps","k","keys","filterSupportedAttributes","permanent","tone","className","class","handleSubscriptions","which","update","handleDismissTap","e","defaultPrevented","listenEl","body","activateDismissTap","addEventListener","deActivateDismissTap","removeEventListener","handleEscape","hideDelay","onMount","onUnMount","createContent","h","renderer","Shadow","z","onclick","preventDefault","children"],"mappings":"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"}