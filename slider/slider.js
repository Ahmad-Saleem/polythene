"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}require("polythene/common/object.assign");var _polythenePolythenePolythene=require("polythene/polythene/polythene");var _polythenePolythenePolythene2=_interopRequireDefault(_polythenePolythenePolythene);var _mithril=require("mithril");var _mithril2=_interopRequireDefault(_mithril);require("polythene-theme/slider/slider");var _polytheneThemeSliderSliderStyleConfig=require("polythene-theme/slider/slider-style-config");var _polytheneThemeSliderSliderStyleConfig2=_interopRequireDefault(_polytheneThemeSliderSliderStyleConfig);var IS_IE=window.navigator.msPointerEnabled;var positionToValue=function positionToValue(ctrl,x){var elWidth=ctrl.inputEl.getBoundingClientRect().width-_polytheneThemeSliderSliderStyleConfig2["default"].thumbSize;var relX=Math.max(0,Math.min(1,1/elWidth*(x-_polytheneThemeSliderSliderStyleConfig2["default"].thumbSize/2)));return ctrl.min+(ctrl.max-ctrl.min)*relX};var valueToPosition=function valueToPosition(ctrl){var elWidth=ctrl.inputEl.getBoundingClientRect().width-_polytheneThemeSliderSliderStyleConfig2["default"].thumbSize;var marginLeft=parseInt(window.getComputedStyle(ctrl.inputEl).marginLeft,10);return marginLeft+_polytheneThemeSliderSliderStyleConfig2["default"].thumbSize/2+elWidth*ctrl.fraction()};var valueFromTouchEvent=function valueFromTouchEvent(ctrl,touchEvent){return positionToValue(ctrl,touchEvent.layerX)};var updatePinPosition=function updatePinPosition(ctrl){if(ctrl.inputEl&&ctrl.pinEl){ctrl.pinEl.style.left=valueToPosition(ctrl)+"px"}};var updateValue=function updateValue(ctrl,value){ctrl.setValue(value);ctrl.updateFraction();updatePinPosition(ctrl)};var generateStepItems=function generateStepItems(min,max,stepSize){var steps=Math.round((max-min)/stepSize);var items=[];var s=steps+1;while(s>0){items.push((0,_mithril2["default"])("div"));s--}return items};var createSlider=function createSlider(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];var fraction=ctrl.fraction();return[(0,_mithril2["default"])("input",Object.assign({},{"class":["slider-control",fraction===0?"is-min":null,opts.pin?"pin":null].join(" "),type:"range",min:ctrl.min,max:ctrl.max,tabindex:0,config:function config(el,inited){if(inited)return;ctrl.inputEl=el;var value=ctrl.value();ctrl.inputEl.value=value;var needsUpdate=value!==el.value;updateValue(ctrl,el.value);if(needsUpdate){setTimeout(function(){return _mithril2["default"].redraw()},0)}}},opts.disabled?{disabled:true}:{onmousedown:function onmousedown(e){updateValue(ctrl,e.target.value)},onchange:function onchange(e){updateValue(ctrl,e.target.value)},oninput:function oninput(e){updateValue(ctrl,e.target.value)},onmouseup:function onmouseup(){ctrl.inputEl.blur()},ontouchstart:function ontouchstart(e){e.preventDefault();var value=valueFromTouchEvent(ctrl,e);ctrl.inputEl.value=value;updateValue(ctrl,ctrl.inputEl.value)},ontouchmove:function ontouchmove(e){e.preventDefault();var value=valueFromTouchEvent(ctrl,e);ctrl.inputEl.value=value;updateValue(ctrl,ctrl.inputEl.value)},ontouchend:function ontouchend(e){e.preventDefault();ctrl.inputEl.blur()}},opts.step!==undefined?{step:opts.step}:null)),(0,_mithril2["default"])(".slider-background",[(0,_mithril2["default"])(".slider-background-lower",{style:{flex:fraction+" 1 0%",webkitFlex:fraction+" 1 0%"}}),(0,_mithril2["default"])(".slider-background-upper",{style:{flex:1-fraction+" 1 0%",webkitFlex:1-fraction+" 1 0%"}})]),opts.step&&!opts.disabled?(0,_mithril2["default"])(".slider-steps.layout.justified",generateStepItems(ctrl.min,ctrl.max,parseInt(opts.step,10))):null,opts.pin&&opts.step&&!opts.disabled?(0,_mithril2["default"])(".slider-pin",{value:Math.round(ctrl.value()),config:function config(el,inited){if(inited)return;ctrl.pinEl=el}}):null]};var createView=function createView(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];var tag=opts.tag||"div";var props={"class":["slider",opts.disabled?"disabled":null,opts.pin?"pin":null,opts["class"]].join(" "),id:opts.id||"",config:function config(el,inited){if(inited)return;if(opts.step&&!opts.disabled){updatePinPosition(ctrl)}}};var content=createSlider(ctrl,opts);if(IS_IE){return(0,_mithril2["default"])(".slider-ie-container",(0,_mithril2["default"])(tag,props,_polythenePolythenePolythene2["default"].insertContent(content,opts)))}else{return(0,_mithril2["default"])(tag,props,_polythenePolythenePolythene2["default"].insertContent(content,opts))}};var component={controller:function controller(){var opts=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var _value=opts.value!==undefined?opts.value:0;var min=opts.min!==undefined?opts.min:0;var max=opts.max!==undefined?opts.max:100;var _fraction=0;var updateFraction=function updateFraction(){_fraction=(_value-min)/(max-min)};var setValue=function setValue(v){_value=v;if(opts.getValue){opts.getValue(v)}};setValue(_value);updateFraction();return{min:min,max:max,inputEl:null,pinEl:null,setValue:setValue,value:function value(){return _value},fraction:function fraction(){return _fraction},updateFraction:updateFraction}},view:function view(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];return createView(ctrl,opts)}};exports["default"]=component;module.exports=exports["default"];